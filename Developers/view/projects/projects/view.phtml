<?
/**
 * @var array $members
 * @var \Developers\Model\Developer[] $developers
 * @varDevelopersts\Model\Developer $developer
 * @vDevelopersects\Model\Developer[] $rDevelopersojects
 * @var \Catalog\Model\Series[] $relatedSeries
 * @var $sl
 Developers\Model\Developer $prevProdDevelopers \Developers\Model\Developer $nextPrDevelopersar \Developers\Model\DeveloperImg[] $imgs
 */
?>


<div class="b-developer-page">
    <div class="b-section__content">
        <div class="b-breadcrumbs">
            <? foreach ($breadCrumbs as $bc) { ?>
                <a class="b-breadcrumbs__item" href="<?= $bc['link'] ?>"><?= $bc['text'] ?></a>&nbsp;/
            <? } ?>
            <strong class="b-breadcrumbs__item b-breadcrumbs__item_active"><?= $pageTitle ?></strong>
        </div>
    </div>
    <div style="display: none">
        <? foreach($imgs as $img) { ?>
            <? $src = $this->basePath() . '/images/developers/'  . $img->url ?>

            <img style="display: none" src="<?= $src ?>" />

        <? } ?>
    </div>
    <div class="b-slider-outer b-section">
        <div style="display: none" id="imagesLoadedDeveloper">
            <? foreach ($imgs as $img) { ?>
                <div class="b-slider__item b-slider_developer__item">
                    <i class="b-slider-item-layout" style="width: 1px"></i>
                    <? $minUrl = 'min_' . $img->url ?>
                    <? $src = $this->basePath() . '/images/developers/' . $img->url ?>
                    <? $minSrc = $this->basePath() . '/images/developers/' . $minUrl ?>

                    <a class="b-goods-gallery-item__link" href="<?= $src ?>" rel="gallery">
                        <img class="b-slider__image" src="<?= file_exists($_SERVER['DOCUMENT_ROOT'] . '/images/developers/min_' . $img->url) ? $minSrc : $src ?>" alt="<?= $series->visible_title; ?> url" />
                    </a>
<!--                    <a href="/images/developers/--><?//= $img->url ?><!--" rel="gallery">-->
<!--                        <img class="b-slider__image" src="/images/developers/--><?//= $img->url ?><!--"/>-->
<!--                    </a>-->
                </div>
            <? } ?>
        </div>
        <div class="b-slider b-slider_developer">
        </div>

        <div class="b-slider-arrows b-slider-arrows_developer">
        </div>
    </div>
    <script type="text/javascript">
        (function () {
            function DeveloperSlider() {
                var _options = {
                        isAnimating: false,
                        direction: "next",
                        fancyIsOpen: false,
                        animatingSpeed: browser.mobile ? 300 : 500,
                        $slider: jQuery('.b-slider_developer'),
                        fancySwipingClass: "fancybox-swiping",
                        slidesToShow: 1,
                        imagesContainer: "#imagesLoadedDeveloper",
                        noSliderClass: "b-slider_no-slider"
                    },
                    $document = jQuery(document),
                    $html = jQuery("html"),
                    _ = _options,
                    _init = function () {
                        _initSlider();

                    },
                    _initSlider = function () {
                        _.$slider.slick({
                            accessibility: false,
                            dots: false,
                            infinite: true,
                            speed: _.animatingSpeed,
                            slidesToShow: _.slidesToShow,
                            touchThreshold: browser.mobile ? 5 : 50,
                            centerMode: true,
                            centerPadding: "0px",
                            variableWidth: true,
                            appendArrows: jQuery(".b-slider-arrows_developer"),
                            arrows: browser.mobile ? false : true,
                            prevArrow: "<a href=\"javascript:void(0)\" class=\"b-slider-arrows__arrow b-slider-arrows_developer__arrow b-slider-arrows__arrow_prev\" ></a>",
                            nextArrow: "<a href=\"javascript:void(0)\" class=\"b-slider-arrows__arrow b-slider-arrows_developer__arrow b-slider-arrows__arrow_next\" ></a>"
                        });

                        var imgLoad = imagesLoaded(_.imagesContainer);
                        imgLoad.on("always", function (instance) {
                            var loadedImages = jQuery.grep(imgLoad.images, function (a) {
                                return a.isLoaded == true;
                            });
                            _slideAdd(loadedImages);

                        });

                    },

                    _slideAdd = function (images) {
                        if (!images.length) return;
                        var slideElements = "";
                        for (var i = 0; i < images.length; ++i) {
                            slideElements += jQuery(images[i].img).parentsUntil(_.imagesContainer).last()[0].outerHTML;
                        }


                        _.$slider.slick("slickAdd", slideElements);
                        if (images.length <= _.slidesToShow) {
                            _.$slider.slick("unslick");
                            _.$slider.addClass(_.noSliderClass);
                        }

                        _initFancy();
                        _bindEvents();

                    },
                    _initFancy = function () {
                        _.$imagesLinks = _.$slider.find(".b-slider__item > a");
//                        _.$imagesLinks = _.$slider.find(".b-slider__item:not(.slick-cloned) > a");
                        _.$fancy = _.$imagesLinks.fancybox({
                            opacity: true,
                            padding: 20,
                            overlayShow: true,
                            loop: true,
                            parent: ".swipe-layout",
                            transitionIn: 'elastic',
                            transitionOut: 'elastic',
                            helpers: {
                                overlay: {
                                    closeClick: true
                                }
                            },
                            prevSpeed: _.animatingSpeed,
                            nextSpeed: _.animatingSpeed,
                            beforeLoad: function () {
                                if (_.isAnimating) return false;
                                _.isAnimating = true;
                                if (!_.firstCalling && !_.checked) {
                                    _.firstCalling = true;
                                    _.checked = true;
                                }
                                _.$fancy.triggerHandler("fancyBox.beforeLoad");
                            },
                            keys: {
                                next: {
                                    39: 'left'
                                },
                                prev: {
                                    37: 'right'
                                }
                            },
                            afterClose: function () {
                                _.fancyIsOpen = false;
                                $html.removeClass(_.fancySwipingClass);
                                jQuery(".fancybox-overlay").off("mousedown.preventDrag");
                                $document.off("ng.swipe.right.developer").off("ng.swipe.left.developer");
                                _.firstCalling = false;
                                _.checked = false;
                            },
                            beforeShow: function () {
                                $document.on("ng.swipe.right.developer", function () {
                                    if (_.isAnimating) return;
                                    _.direction = "prev";
                                    $.fancybox.prev();
                                }).on("ng.swipe.left.developer", function () {
                                    if (_.isAnimating) return;
                                    _.direction = "next";
                                    $.fancybox.next();
                                });
                            },
                            afterShow: function () {
                                _.fancyIsOpen = true;
                                _.isAnimating = false;
                                $html.addClass(_.fancySwipingClass);
                                //�������� �������������� ��� ������
                                jQuery(".fancybox-overlay").on("mousedown.preventDrag", function (e) {
                                    e.preventDefault();
                                });
                                document.addEventListener("keyup", function (e) {
                                    if (_.isAnimating && _.fancyIsOpen) {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        return;
                                    }
                                    if (e.keyCode == 39) {
                                        _.direction = "next";
                                    } else if (e.keyCode == 37) {
                                        _.direction = "prev";
                                    }
                                }, true);
                            },
                        });
                    },
                    _bindEvents = function () {
                        _.$slider.on("mousedown", function () {
                            return false;
                        });
                        _.$slider.on("click", function (e) {
                            var $this = jQuery(e.target),
                                id = $this.closest("[data-slick-index]").data("slick-index");
                            _.$slider.slick("slickGoTo", id, false);
                            $this.siblings("a").click();
                        }).on("afterChange", function () {
                            _.isAnimating = false;
                        });


                        _.$fancy.on("fancyBox.beforeLoad", function () {
                            if (_.firstCalling) {
                                _.firstCalling = false;
                                return;
                            }
                            _.$slider.slick(_.direction == "next" ? "slickNext" : "slickPrev");
                        });


                        document.addEventListener("click", function (e) {
                            var $nextButton, $prevButton;
                            if (_.fancyIsOpen) {
                                $nextButton = jQuery(e.target).closest(".fancybox-next");
                                $prevButton = jQuery(e.target).closest(".fancybox-prev");
                            } else {
                                return;
                            }
                            if (!$nextButton.length && !$prevButton.length) {
                                return;
                            }
                            if (_.isAnimating) {
                                e.preventDefault();
                                e.stopPropagation();
                                return;
                            }

                            _.direction = $nextButton.length ? "next" : "prev";
                        }, true);


                    };
                return {init: _init};
            }

            DeveloperSlider().init();
        })();
    </script>

    <br/>
    <br/>

    <div class="b-section">
        <div class="b-section__content">


            <div class="b-about-developer">
                <div class="b-about-developer__row">
                    <div class="b-about-developer__cell b-about-developer__cell_left b-about-developer__cell_heading">
                        <h4 class="b-about-developer__heading"><?= $developer->title ?></h4>
                    </div>
                    <div class="b-about-developer__cell b-about-developer__cell_center">
                    </div>
                    <div class="b-about-developer__cell b-about-developer__cell_right  b-about-developer__cell_heading">
                        <h4 class="b-about-developer__heading b-about-developer__heading_products">Оборудование в проекте</h4>
                    </div>
                </div>
                <div class="b-about-developer__row">
                    <div class="b-about-developer__cell b-about-developer__cell_left">
                        <div class="b-developer-description">
                            <?= $developer->text ?>
                        </div>
                    </div>
                    <div class="b-about-developer__cell b-about-developer__cell_center">
                        <div class="b-about-developer__separator"></div>
                    </div>

                    <div class="b-about-developer__cell b-about-developer__cell_right">
                        <div class="b-developer-products">

                            <h4 class="b-developer-products__product-name"></h4>

                            <div class="b-developer-products-slider">
                                <? foreach ($relatedSeries as $relatedItem) { ?>
                                    <div class="b-developer-products-slider__item">
                                        <i class="b-slider-item-layout"></i>
                                        <? if ($relatedItem->previewName) { ?>
                                            <a href="/images/series/<?= $relatedItem->previewName ?>"
                                               rel="developer_product_gallery">
                                                <img class="b-developer-products-slider__image"
                                                     src="/images/series/<?= $relatedItem->previewName ?>"/>
                                            </a>
                                        <? } else { ?>
                                            <a href="/images/series/<?= $relatedItem->img ?>"
                                               rel="developer_product_gallery">
                                                <img class="b-developer-products-slider__image"
                                                     src="/images/series/<?= $relatedItem->img ?>"/>
                                            </a>
                                        <? } ?>
                                    </div>
                                <? } ?>

                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    function DeveloperProductSlider() {
        var _options = {
                isAnimating: false,
                direction: "next",
                fancyIsOpen: false,
                animatingSpeed: browser.mobile ? 300 : 500,
                $slider: jQuery('.b-developer-products-slider'),
                fancySwipingClass: "fancybox-swiping",
                productHeadingsHtml: [
                    <? foreach ($relatedSeries as $relatedItem) { ?>
                    <? if (isset($relatedItem->isProduct) && $relatedItem->isProduct) { ?>
                    "<a href=\"/catalog/product/<?= $relatedItem->id ?>/\"><?= $relatedItem->title ?></a>",
                    <? } else { ?>
                    "<a href=\"/catalog/series/<?= $relatedItem->id ?>/\"><?= $relatedItem->visible_title ? $relatedItem->visible_title : $relatedItem->title ?></a>",
                    <? } ?>
                    <? } ?>
                ],
                $productHeadingContainer: jQuery(".b-developer-products__product-name")

            }, _ = jQuery.extend(_options, {
                $sliderItems: _options.$slider.find(".b-developer-products-slider__item"),
                $imagesLinks: _options.$slider.find(".b-developer-products-slider__item:not('.slick-cloned') > a")
            }),
            $document = jQuery(document),
            $html = jQuery("html"),

            _init = function () {
                _initSlider();
                _initFancy();
                _bindEvents();

            },
            _showProductHeading = function (index) {
                _.$productHeadingContainer.html(_.productHeadingsHtml[index]);
            },
            _getCurrentSlideIndex = function () {
                return _.$slider.slick("slickCurrentSlide");
            },

            _bindEvents = function () {
                _.$slider.on("mousedown", function () {
                    return false;
                });

                _.$fancy.on("fancyBox.beforeLoad", function () {
                    if (_.firstCalling) {
                        _.firstCalling = false;
                        return;
                    }
                    _.$slider.slick(_.direction == "next" ? "slickNext" : "slickPrev");
                });


                document.addEventListener("click", function (e) {
                    var $nextButton, $prevButton;
                    if (_.fancyIsOpen) {
                        $nextButton = jQuery(e.target).closest(".fancybox-next");
                        $prevButton = jQuery(e.target).closest(".fancybox-prev");
                    } else {
                        return;
                    }
                    if (!$nextButton.length && !$prevButton.length) {
                        return;
                    }
                    if (_.isAnimating) {
                        e.preventDefault();
                        e.stopPropagation();
                        return;
                    }

                    _.direction = $nextButton.length ? "next" : "prev";
                }, true);

            },
            _initFancy = function () {
                _.$fancy = _.$imagesLinks.fancybox({
                    opacity: true,
                    padding: 20,
                    overlayShow: true,
                    loop: true,
                    transitionIn: 'elastic',
                    transitionOut: 'elastic',
                    helpers: {
                        overlay: {
                            closeClick: false
                        }
                    },
                    prevSpeed: _.animatingSpeed,
                    nextSpeed: _.animatingSpeed,
                    beforeLoad: function () {
                        if (_.isAnimating) return false;
                        _.isAnimating = true;
                        if (!_.firstCalling && !_.checked) {
                            _.firstCalling = true;
                            _.checked = true;
                        }

                        _.$fancy.triggerHandler("fancyBox.beforeLoad");
                    },
                    keys: {
                        next: {
                            39: 'left'
                        },
                        prev: {
                            37: 'right'
                        }
                    },
                    afterClose: function () {
                        _.fancyIsOpen = false;
                        $html.removeClass(_.fancySwipingClass);
                        jQuery(".fancybox-overlay").off("mousedown.preventDrag");
                        $document.off("ng.swipe.right.products").off("ng.swipe.left.products");
                        _.firstCalling = false;
                        _.checked = false;
                    },
                    beforeShow: function () {
                        $document.on("ng.swipe.right.products", function () {
                            if (_.isAnimating) return;
                            _.direction = "prev";
                            $.fancybox.prev();
                        }).on("ng.swipe.left.products", function () {
                            if (_.isAnimating) return;
                            _.direction = "next";
                            $.fancybox.next();
                        });
                    },

                    afterShow: function () {
                        _.fancyIsOpen = true;
                        _.isAnimating = false;
                        $html.addClass(_.fancySwipingClass);
                        //отменяем перетаскивание при свайпе
                        jQuery(".fancybox-overlay").on("mousedown.preventDrag", function (e) {
                            e.preventDefault();
                        });
                        document.addEventListener("keyup", function (e) {
                            if (_.isAnimating && _.fancyIsOpen) {
                                e.preventDefault();
                                e.stopPropagation();
                                return;
                            }
                            if (e.keyCode == 39) {
                                _.direction = "next";
                            } else if (e.keyCode == 37) {
                                _.direction = "prev";
                            }
                        }, true);
                    },
                });
            },
            _initSlider = function () {
                _.$slider.on("init", function () {
                    setTimeout(function () {
                        _showProductHeading(_getCurrentSlideIndex());
                    });
                }).
                    on("beforeChange", function (e, current, currentIndex, nextIndex) {
                        console.log(nextIndex);
//                        _showProductHeading(_getCurrentSlideIndex());
                        _showProductHeading(nextIndex);
                        _.isAnimating = false;
                    }).slick({
                        accessibility: false,
                        dots: false,
                        infinite: true,
                        speed: _.animatingSpeed,
                        fade: true,
                        touchThreshold: browser.mobile ? 5 : 50,
                        slidesToShow: 1,
                        centerMode: true,
                        prevArrow: "<a href=\"javascript:void(0)\" class=\"b-developer-products-slider__arrow b-developer-products-slider__arrow_prev\"></a>",
                        nextArrow: "<a href=\"javascript:void(0)\" class=\"b-developer-products-slider__arrow b-developer-products-slider__arrow_next\"></a>"
                    });
            };

        return {init: _init};
    }

    DeveloperProductSlider().init();


</script>

<script type="application/javascript">
    $(window).keyup(function(event) {
        if(event.ctrlKey){
            if (event.keyCode==37) {
                document.location = "/developers/view/<?= $this->prevProd->id ?>";
            } else if (event.keyCode==39) {
                document.location = "/developers/view/<?= $this->nextProd->id ?>";
            }
        }
    });
</script>